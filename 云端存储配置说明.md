# 云端存储功能配置说明

## ⚠️ 重要提示

**LeanCloud 已不再接受新用户注册！**

本项目已改用 **Supabase** 作为云端存储方案。

---

## ✅ 当前使用方案：Supabase

### 为什么选择 Supabase？

- ✅ 完全免费（免费额度足够个人使用）
- ✅ 支持新用户注册
- ✅ 提供 PostgreSQL 数据库
- ✅ 自动备份和恢复
- ✅ 实时数据同步
- ✅ 强大的 API 和 SDK

---

## 📦 使用 Supabase 实现云端数据存储

### 一、注册和配置 Supabase

#### 1. 注册账号
- 访问：https://supabase.com
- 点击 "Start your project"
- 使用 GitHub 账号登录（推荐）或邮箱注册
- 验证后登录控制台

#### 2. 创建项目
- 点击 "New project"
- 项目名称：`fund-portfolio`（或任意名称）
- 设置数据库密码（请记住这个密码）
- 选择区域：推荐选择 "Northeast Asia (Tokyo)" 或 "Southeast Asia (Singapore)"
- 点击 "Create new project"
- 等待项目创建完成（约1-2分钟）

#### 3. 获取凭证
- 项目创建完成后，点击左侧 "Settings" → "API"
- 记录以下信息：
  ```
  Project URL: https://你的项目ID.supabase.co
  anon public key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...（很长的字符串）
  ```

#### 4. 创建数据库表
- 点击左侧 "Table Editor"
- 点击 "New Table"
- 表名：`fund_data`
- 添加以下列：
  - `user_id` (text, 必填)
  - `data` (jsonb, 必填)
  - `updated_at` (timestamptz, 默认值: now())
- 保存表

**详细的表创建步骤请参考：`Supabase数据库表创建指南.md`**

---

### 二、代码已集成完成

**好消息！** 你的HTML文件已经完成了 Supabase 集成，无需再修改代码！

#### 已集成的功能：

✅ Supabase SDK 已添加  
✅ 配置和初始化代码已添加  
✅ 云端保存函数 `saveToCloud()` 已实现  
✅ 云端加载函数 `loadFromCloud()` 已实现  
✅ 手动同步函数 `loadFromCloudManual()` 已实现  
✅ 通知提示功能 `showNotification()` 已实现  
✅ 自动保存到云端（修改数据时自动触发）  
✅ 页面加载时优先从云端加载数据  
✅ 云端同步按钮已添加到界面  

#### 你的配置信息：

```javascript
const SUPABASE_URL = 'https://tweusnlqlgiiuchlfbdr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3ZXVzbmxxbGdpaXVjaGxmYmRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjkxMjksImV4cCI6MjA4NTk0NTEyOX0.3-JvqUMlHigtjwcGHZDdaOhvwq1dDLeoqn2A0gxXNPg';
```

---

### 三、下一步操作

#### 🎯 你现在需要做的：

1. **创建数据库表**
   - 按照 `Supabase数据库表创建指南.md` 的步骤操作
   - 在 Supabase 控制台创建 `fund_data` 表

2. **测试云端同步**
   - 打开HTML文件
   - 修改一些数据
   - 观察右上角通知
   - 在 Supabase 控制台查看数据

3. **开始使用**
   - 数据会自动保存到云端
   - 在任何设备上都能访问

---

### 四、工作原理

#### 数据流程：

```
用户操作（修改数据）
    ↓
calcAll() 或其他修改函数
    ↓
saveToLocal()
    ↓
localStorage.setItem() + saveToCloud()
    ↓
数据同时保存到本地和云端
```

#### 加载流程：

```
打开页面
    ↓
window.onload
    ↓
优先从云端加载 loadFromCloud()
    ↓
如果云端有数据 → 使用云端数据
    ↓
如果云端没有 → 使用本地数据 → 同步到云端
    ↓
渲染页面
```

---

### 五、数据结构

在 Supabase 的 `fund_data` 表中：

| 列名 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键，自动生成 |
| user_id | text | 用户唯一标识 |
| data | jsonb | 完整的 appData 对象 |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 最后更新时间 |

---

### 六、多设备使用

#### 方案A：使用设备指纹（当前实现）
- 每个设备自动生成唯一ID
- 不同设备数据独立
- 需要手动导入导出来同步

#### 方案B：添加用户登录（推荐）

可以添加 Supabase Auth 登录功能：

```javascript
// 使用 Supabase Auth 登录
async function loginWithEmail(email, password) {
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        userId = data.user.id;
        localStorage.setItem('userId', userId);
        showNotification('登录成功', 'success');
        
        // 加载用户数据
        await loadFromCloud();
        renderApp();
    } catch (error) {
        showNotification('登录失败: ' + error.message, 'error');
    }
}

// 注册新用户
async function signUpWithEmail(email, password) {
    try {
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        userId = data.user.id;
        localStorage.setItem('userId', userId);
        showNotification('注册成功', 'success');
    } catch (error) {
        showNotification('注册失败: ' + error.message, 'error');
    }
}
```

---

### 七、费用说明

**Supabase 免费版额度：**
- 数据库存储：500 MB
- 带宽：5 GB/月
- API 请求：无限制
- 文件存储：1 GB
- 实时连接：200 个并发

**你的使用情况估算：**
- 每次保存：约 10-50 KB 数据
- 每次加载：约 10-50 KB 数据
- 假设每天操作 20 次 = 约 1 MB/天
- 一个月约 30 MB，远低于免费额度 ✅

---

### 八、安全建议

1. **API Key 安全**
   - anon public key 可以安全地暴露在前端代码中
   - 通过 RLS（行级安全）策略控制数据访问
   - 不要暴露 service_role key

2. **启用行级安全（RLS）**
   - 在 Supabase 控制台启用 RLS
   - 添加适当的访问策略
   - 详见 `Supabase数据库表创建指南.md`

3. **定期备份**
   - 虽然有云端存储，但建议定期导出JSON备份
   - 使用 "⬇️ 备份配置" 功能

---

### 九、测试步骤

1. 在本地打开HTML文件
### 九、测试步骤

**详细的测试步骤请参考：`Supabase数据库表创建指南.md`**

简要步骤：
1. 在 Supabase 创建 `fund_data` 表
2. 打开HTML文件
3. 修改数据，观察通知
4. 在 Supabase 控制台查看数据
5. 清空缓存，重新加载，验证数据恢复

---

### 十、故障排查

**问题1：保存失败，提示 "relation does not exist"**
- 原因：表还没有创建
- 解决：在 Supabase 创建 `fund_data` 表

**问题2：保存失败，提示 "permission denied"**
- 原因：RLS 策略配置不正确
- 解决：禁用 RLS 或添加正确的策略

**问题3：数据加载失败**
- 打开浏览器控制台查看错误信息
- 检查网络连接
- 检查 Supabase 服务是否正常

**问题4：数据不同步**
- 确认 userId 在不同设备上是否一致
- 如果需要多设备同步，建议使用登录功能

---

## 🎉 完成后的效果

- ✅ 打开页面自动从云端加载最新数据
- ✅ 每次修改自动保存到云端
- ✅ 在任何设备上访问都是同一份数据
- ✅ 不依赖浏览器缓存，数据永久保存
- ✅ 可以在 Supabase 控制台查看和管理数据
- ✅ 支持多设备数据同步

---

## 📚 相关文档

- **Supabase数据库表创建指南.md** - 详细的表创建步骤
- **云端版使用说明.md** - 云端版功能使用指南
- **Supabase云存储集成代码.md** - 代码集成参考

---

## 🚀 开始使用

你的代码已经准备好了！现在只需要：

1. 按照 `Supabase数据库表创建指南.md` 创建数据库表
2. 打开HTML文件开始使用
3. 享受云端同步的便利！
