<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å®šæŠ•ç³»ç»Ÿ (V7 å…¨èƒ½æ——èˆ°ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --primary: #1890ff;       
            --text-main: #333333;
            --text-sub: #666666;
            --border: #e8e8e8;
            
            /* è¯­ä¹‰è‰² */
            --pos: #ff4d4f; /* æ¶¨/ä¹°å…¥/è¶…é… */
            --neg: #52c41a; /* è·Œ/å–å‡º/ä½é… */
            --warn: #faad14; 
            
            --radius: 8px;
            --shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 30px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* --- 1. é¡¶éƒ¨æ·±è“æŒ‡æŒ¥èˆ± --- */
        .dashboard-config {
            background: #1867c0;
            color: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(24, 103, 192, 0.2);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .config-group { display: flex; gap: 30px; align-items: center; }
        .config-item label { display: block; font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 8px; }
        
        .dash-input {
            background: white; border: none; color: #333;
            padding: 10px 15px; border-radius: 6px; font-size: 20px; font-weight: bold;
            width: 180px; font-family: 'Consolas', monospace;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .dash-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }

        .summary-group { display: flex; gap: 40px; text-align: right; }
        .summary-label { font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase; }
        .summary-val { font-size: 32px; font-weight: 800; color: #fff; letter-spacing: -0.5px; line-height: 1.2;}
        .summary-sub { font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 4px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 25px;}
        .btn-dash {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 12px; transition: all 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-dash:hover { background: rgba(255,255,255,0.3); }
        .btn-toggle-active { background: #fff !important; color: #1867c0 !important; font-weight: bold; }

        /* --- 2. èµ„äº§åˆ†æçœ‹æ¿ (é»˜è®¤éšè—) --- */
        .analysis-dashboard {
            display: none; 
            grid-template-columns: 400px 1fr;
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch; 
        }
        @media (max-width: 900px) { .analysis-dashboard { grid-template-columns: 1fr; } }

        .chart-card {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 20px; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 320px;
        }
        .chart-container-inner { width: 100%; height: 100%; max-height: 300px; position: relative; }

        .rebalance-card {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 25px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box;
        }
        .rb-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; color: #333; }
        
        .rb-table { width: 100%; border-collapse: collapse; font-size: 14px; flex: 1; }
        .rb-table th { text-align: left; padding: 12px 10px; background: #fafafa; color: #888; font-weight: 600; border-bottom: 1px solid #eee; }
        .rb-table td { padding: 14px 10px; border-bottom: 1px solid #f5f5f5; color: #333; font-weight: 500; }
        .rb-table tr:last-child td { border-bottom: none; }
        
        .tag-status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 800; }
        .st-over { background: #fff1f0; color: var(--pos); border: 1px solid #ffa39e; }
        .st-under { background: #fffbe6; color: var(--warn); border: 1px solid #ffe58f; }
        .st-ok { background: #f6ffed; color: var(--neg); border: 1px solid #b7eb8f; }

        .rb-action { font-family: 'Consolas', monospace; font-weight: 800; font-size: 15px;}
        .act-sell { color: var(--neg); } 
        .act-buy { color: var(--pos); }  
        
        .rb-tip { margin-top: 15px; padding-top: 15px; font-size: 12px; color: #999; border-top: 1px dashed #eee; line-height: 1.6; }

        /* --- 3. å¤åˆ©è®¡ç®—å™¨æ¨¡å— (æ–°å¢) --- */
        .compound-dashboard {
            display: none; /* é»˜è®¤éšè— */
            grid-template-columns: 350px 1fr;
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch;
        }
        @media (max-width: 900px) { .compound-dashboard { grid-template-columns: 1fr; } }

        .compound-inputs {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 25px; display: flex; flex-direction: column; gap: 20px;
        }
        .cp-title { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 5px; }
        
        .input-row label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
        .input-row input { 
            width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;
            font-size: 16px; font-weight: bold; box-sizing: border-box;
        }
        .input-row input:focus { border-color: var(--primary); outline: none; }

        .result-box {
            background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee; margin-top: 10px;
        }
        .res-label { font-size: 12px; color: #888; text-transform: uppercase; }
        .res-val { font-size: 24px; font-weight: 800; margin-top: 2px; }
        .res-val.type-a { color: #faad14; } /* æ©™è‰² - ä¸€æ¬¡æ€§ */
        .res-val.type-b { color: #1890ff; } /* è“è‰² - å®šæŠ• */

        /* --- ä»Šæ—¥ç›ˆäºæ¨¡å— --- */
        .daily-pnl-dashboard {
            display: none;
            margin-bottom: 30px;
        }

        .pnl-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .pnl-header {
            background: #1867c0;
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .pnl-title {
            font-size: 20px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pnl-summary {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .pnl-summary-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .pnl-label {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 5px;
        }

        .pnl-value {
            font-size: 28px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
        }

        .pnl-count {
            font-size: 24px;
            font-weight: 800;
            color: #52c41a;
        }

        .pnl-count.loss {
            color: #ff4d4f;
        }

        .pnl-loading {
            padding: 60px;
            text-align: center;
            color: #999;
            display: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top-color: #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pnl-content {
            padding: 25px;
            background: var(--bg-body);
        }

        .pnl-sector {
            border-top: 5px solid #ccc;
            margin-bottom: 15px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            background: white;
        }

        .pnl-sector:last-child {
            margin-bottom: 0;
        }

        .pnl-sector-header {
            background: #fafafa;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
        }

        .pnl-sector-name {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pnl-sector-total {
            font-size: 18px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
        }

        .pnl-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .pnl-table th {
            background: #f9f9f9;
            padding: 12px 15px;
            text-align: left;
            font-size: 12px;
            color: #888;
            font-weight: 600;
            border-bottom: 1px solid #eee;
        }

        .pnl-table th:nth-child(1) { width: 10%; } /* åŸºé‡‘ä»£ç  */
        .pnl-table th:nth-child(2) { width: 25%; } /* åŸºé‡‘åç§° */
        .pnl-table th:nth-child(3) { width: 12%; } /* å•ä½å‡€å€¼ */
        .pnl-table th:nth-child(4) { width: 12%; } /* æ—¥æ¶¨å¹… */
        .pnl-table th:nth-child(5) { width: 15%; } /* æŒä»“ä»½é¢ */
        .pnl-table th:nth-child(6) { width: 16%; text-align: right; } /* ä»Šæ—¥æ”¶ç›Š */

        .pnl-table td:nth-child(1) { width: 10%; }
        .pnl-table td:nth-child(2) { width: 25%; }
        .pnl-table td:nth-child(3) { width: 12%; }
        .pnl-table td:nth-child(4) { width: 12%; }
        .pnl-table td:nth-child(5) { width: 15%; }
        .pnl-table td:nth-child(6) { width: 16%; text-align: right; }

        .pnl-table td {
            padding: 15px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 14px;
            color: #333;
        }

        .pnl-table tr:last-child td {
            border-bottom: none;
        }

        .pnl-table tr:hover {
            background: #fafafa;
        }

        .fund-code {
            font-family: 'Consolas', monospace;
            color: #666;
            font-size: 13px;
        }

        .fund-name {
            font-weight: 600;
            color: #333;
        }

        .nav-value {
            font-family: 'Consolas', monospace;
            font-weight: 600;
        }

        .growth-rate {
            font-family: 'Consolas', monospace;
            font-weight: 700;
            font-size: 15px;
        }

        .growth-positive {
            color: #ff4d4f;
        }

        .growth-negative {
            color: #52c41a;
        }

        .growth-zero {
            color: #999;
        }

        .share-amount {
            font-family: 'Consolas', monospace;
            color: #666;
        }

        .daily-profit {
            font-family: 'Consolas', monospace;
            font-weight: 800;
            font-size: 16px;
        }

        .profit-positive {
            color: #ff4d4f;
        }

        .profit-negative {
            color: #52c41a;
        }

        .profit-zero {
            color: #999;
        }

        /* --- 4. æ¿å—å¡ç‰‡ --- */
        .sector-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border-top: 5px solid #ccc;
            position: relative;
        }
        
        .card-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        
        .sector-name-input { font-size: 18px; font-weight: 800; color: #333; border: 1px solid transparent; background: transparent; width: 260px; padding: 4px; border-radius: 4px; }
        .sector-name-input:hover { border-color: #eee; }
        .sector-name-input:focus { border-color: var(--primary); outline: none; background: #fff; }

        .strategy-tag { font-size: 12px; padding: 3px 8px; border-radius: 10px; background: #f5f5f5; color: #666; border: 1px solid #e8e8e8; cursor: pointer; }

        .header-right { display: flex; align-items: center; gap: 15px; background: #f9f9f9; padding: 8px 15px; border-radius: 6px; }
        .ratio-label { font-size: 13px; color: #666; }
        .ratio-input { width: 40px; text-align: center; border: 1px solid #d9d9d9; padding: 4px; border-radius: 4px; font-weight: bold; color: #333; background: #fff; }
        .ratio-input:focus { border-color: var(--primary); outline: none; }
        
        .progress-mini { font-size: 12px; color: #999; margin-left: 10px; }

        .tool-bar { display: flex; gap: 5px; margin-right: 10px; }
        .color-picker { width: 20px; height: 20px; padding: 0; border: none; cursor: pointer; background: none; vertical-align: middle; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 16px; color: #ccc; }
        .btn-icon:hover { color: #ff4d4f; }

        .table-wrap { padding: 10px 25px 25px 25px; }
        table { width: 100%; border-collapse: collapse; }
        
        .fund-table th { text-align: left; padding: 12px 10px; font-size: 12px; color: #888; font-weight: normal; border-bottom: 1px dashed #eee; }
        .fund-table td { padding: 15px 10px; border-bottom: 1px solid #f5f5f5; vertical-align: middle; font-size: 14px; }
        .fund-table tr:last-child td { border-bottom: none; }
        
        .tb-input { width: 100%; padding: 8px 10px; border: 1px solid #d9d9d9; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 14px; color: #333; transition: all 0.2s; box-sizing: border-box; }
        .tb-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); }
        .tb-sm { width: 60px; text-align: center; }

        .result-pill { display: block; padding: 8px 15px; border-radius: 4px; font-family: 'Consolas', monospace; font-weight: 700; font-size: 16px; text-align: right; background: #e6f7ff; color: #1890ff; min-width: 90px; }
        .res-stop { background: #f5f5f5; color: #ccc; font-weight: normal; }
        
        .val-display { font-weight: bold; font-family: 'Consolas', monospace; color: #333; }
        .pf-pos { color: var(--pos); font-size: 12px; }
        .pf-neg { color: var(--neg); font-size: 12px; }

        .btn-add-fund { width: 100%; padding: 12px; border: 1px dashed #d9d9d9; background: #fafafa; color: #666; cursor: pointer; border-radius: 0 0 var(--radius) var(--radius); font-size: 13px; transition: 0.2s; }
        .btn-add-fund:hover { color: var(--primary); border-color: var(--primary); background: #fff; }

        .btn-add-sector { width: 100%; padding: 20px; border: 2px dashed #d9d9d9; border-radius: var(--radius); background: transparent; color: #999; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 40px; transition: 0.2s; }
        .btn-add-sector:hover { border-color: var(--primary); color: var(--primary); background: #f0faff; }

        .warning-box { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; padding: 12px; text-align: center; margin-bottom: 20px; border-radius: var(--radius); font-weight: 600; display: none; }
        
        /* è”ç½‘åŠŸèƒ½æ ·å¼ */
        .sync-status { display: inline-block; margin-left: 10px; font-size: 12px; padding: 3px 8px; border-radius: 4px; }
        .sync-success { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .sync-error { background: #fff2f0; color: #ff4d4f; border: 1px solid #ffccc7; }
        .sync-loading { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; }

        /* --- 5. åº•éƒ¨ç­–ç•¥å¡ç‰‡ --- */
        .strategy-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 40px; margin-bottom: 40px; }
        @media (max-width: 768px) { .strategy-footer { grid-template-columns: 1fr; } }

        .info-card { background: var(--bg-card); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #eee; }
        .info-title { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; }
        .strategy-list, .rules-list { padding-left: 0; list-style: none; margin: 0; }
        .strategy-list li, .rules-list li { margin-bottom: 15px; color: var(--text-sub); font-size: 14px; line-height: 1.6; }
        .strategy-list li strong, .rules-list li strong { color: #333; }
        
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .green { background: #52c41a; }
        .yellow { background: #faad14; }
        .red { background: #ff4d4f; }
        
        .highlight-text { color: #1890ff; font-weight: bold; background: #e6f7ff; padding: 2px 4px; border-radius: 4px; }

        /* --- æŒ‡æ•°é¢æ¿æ ·å¼ --- */
        .index-dashboard {
            background: #1867c0;
            border-radius: var(--radius);
            padding: 20px 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(24, 103, 192, 0.2);
        }

        .index-title {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .index-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        @media (max-width: 1024px) {
            .index-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .index-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .index-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .index-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .index-name {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .index-value {
            color: white;
            font-size: 22px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            margin-bottom: 5px;
        }

        .index-change {
            font-size: 14px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
        }

        .index-change.positive {
            color: #ff6b6b;
        }

        .index-change.negative {
            color: #51cf66;
        }

        .index-change.zero {
            color: rgba(255, 255, 255, 0.7);
        }

    </style>
</head>
<body>

<div class="container">

    <!-- æŒ‡æ•°é¢æ¿ -->
    <div class="index-dashboard">
        <div class="index-title">ğŸ“Š å…¨çƒå¸‚åœºæŒ‡æ•°</div>
        <div class="index-grid">
            <div class="index-item" id="index-ndx">
                <div class="index-name">çº³æ–¯è¾¾å…‹100</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-spx">
                <div class="index-name">æ ‡æ™®500</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-csi300">
                <div class="index-name">æ²ªæ·±300</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-redlow">
                <div class="index-name">ä¸­è¯çº¢åˆ©ä½æ³¢</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-gold">
                <div class="index-name">é»„é‡‘</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
        </div>
    </div>

    <div class="dashboard-config">
        <div style="flex: 1;">
            <div class="config-group">
                <div class="config-item">
                    <label>ğŸ¯ è®¡åˆ’æ€»æŠ•å…¥ (å…ƒ)</label>
                    <input type="number" id="totalGoal" class="dash-input" value="700000" onchange="calcAll()">
                </div>
                <div class="config-item">
                    <label>ğŸ“… è®¡åˆ’å®šæŠ•å‘¨æœŸ (æœˆ)</label>
                    <input type="number" id="months" class="dash-input" value="24" onchange="calcAll()">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-dash" id="btnToggleRb" onclick="toggleRebalance()">ğŸ“Š æ˜¾ç¤ºå†å¹³è¡¡</button>
                <button class="btn-dash" id="btnToggleCp" onclick="toggleCompound()">ğŸ§® å¤åˆ©æ¨æ¼”</button>
                <button class="btn-dash" id="btnTogglePnl" onclick="toggleDailyPnL()">ğŸ’° ä»Šæ—¥ç›ˆäº</button>
                <button class="btn-dash" id="btnToggleEst" onclick="toggleEstimate()">ğŸ“ˆ å®æ—¶é¢„ä¼°</button>
                <button class="btn-dash" onclick="syncAllFundNav()">ğŸ”„ åŒæ­¥å®æ—¶å‡€å€¼</button>
                <button class="btn-dash" onclick="exportData()">â¬‡ï¸ å¤‡ä»½é…ç½®</button>
                <button class="btn-dash" onclick="document.getElementById('importFile').click()">â¬†ï¸ æ¢å¤é…ç½®</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
            <div id="syncStatus" style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.8);"></div>
        </div>

        <div class="summary-group">
            <div class="summary-item">
                <div class="summary-label">å·²æŒä»“å¸‚å€¼</div>
                <div class="summary-val">Â¥<span id="currTotalAsset">0</span></div>
                <div class="summary-sub" id="totalProfitDisplay">--</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">å‰©ä½™éœ€æŠ•å…¥</div>
                <div class="summary-val">Â¥<span id="remainToInvest">0</span></div>
                <div class="summary-sub">å®šæŠ•ç›®æ ‡ç¼ºå£</div>
            </div>
        </div>
    </div>

    <div id="overBudgetWarning" class="warning-box">
        âš ï¸ è­¦å‘Šï¼šå½“å‰æŒä»“å·²è¶…è¿‡æ€»æŠ•å…¥ç›®æ ‡ï¼Œè¯·å¢åŠ æ€»æŠ•å…¥é¢„ç®—ã€‚
    </div>

    <div class="analysis-dashboard" id="rebalancePanel">
        <div class="chart-card">
            <div class="chart-container-inner">
                <canvas id="assetChart"></canvas>
            </div>
            <div style="position:absolute; pointer-events:none; text-align:center;">
                <div style="font-size:12px; color:#999;">æŒä»“åˆ†å¸ƒ</div>
                <div style="font-weight:bold; font-size:18px;">å®æ—¶</div>
            </div>
        </div>

        <div class="rebalance-card">
            <div class="rb-title">âš–ï¸ æ™ºèƒ½å†å¹³è¡¡å»ºè®® (Smart Rebalance)</div>
            <table class="rb-table">
                <thead>
                    <tr>
                        <th>æ¿å—</th>
                        <th style="text-align:center">å®é™…%</th>
                        <th style="text-align:center">ç›®æ ‡%</th>
                        <th style="text-align:center">çŠ¶æ€</th>
                        <th style="text-align:right">å»ºè®®æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="rebalanceBody"></tbody>
            </table>
            <div class="rb-tip">
                ğŸ’¡ <strong>è¯´æ˜ï¼š</strong><br>
                â€¢ åå·®è¶…è¿‡ 2% è§¦å‘é¢œè‰²æç¤ºã€‚<br>
                â€¢ <strong>æ“ä½œå»ºè®®</strong>ï¼šæ­£æ•°ä¸ºâ€œéœ€ä¹°å…¥é‡‘é¢â€(çº¢è‰²)ï¼Œè´Ÿæ•°ä¸ºâ€œéœ€å–å‡ºé‡‘é¢â€(ç»¿è‰²)ã€‚<br>
                â€¢ å»ºè®®ä¼˜å…ˆé€šè¿‡ä¸‹æ–¹â€œå®šæŠ•â€æ¥åŠ¨æ€å¹³è¡¡ï¼ˆä¹°å…¥ä½é…ï¼‰ï¼Œè€Œä¸æ˜¯é¢‘ç¹å–å‡ºã€‚
            </div>
        </div>
    </div>

    <div class="compound-dashboard" id="compoundPanel">
        <div class="compound-inputs">
            <div class="cp-title">ğŸ”® å¤åˆ©è®¡ç®—å™¨ (Compound Interest)</div>
            <div class="input-row">
                <label>æŠ•å…¥æ€»é¢ (å…ƒ)</label>
                <input type="number" id="cpPrincipal" value="1000000" onchange="calcCompound()">
            </div>
            <div class="input-row">
                <label>é¢„ä¼°å¹´åŒ–æ”¶ç›Šç‡ (%)</label>
                <input type="number" id="cpRate" value="10" onchange="calcCompound()">
            </div>
            <div class="input-row">
                <label>æŒæœ‰å¹´æ•°</label>
                <input type="number" id="cpYears" value="10" onchange="calcCompound()">
            </div>
            <div class="result-box">
                <div class="res-label">A. ä¸€æ¬¡æ€§æŠ•å…¥ Nå¹´åæ€»é¢</div>
                <div class="res-val type-a" id="resLumpSum">Â¥0</div>
            </div>
            <div class="result-box">
                <div class="res-label">B. å®šæŠ• Nå¹´åæ€»é¢ (åˆ°è¾¾æ€»é¢)</div>
                <div class="res-val type-b" id="resDCA">Â¥0</div>
                <div style="font-size:12px; color:#999; margin-top:5px;">(æœˆå®šæŠ•: <span id="cpMonthlyInput">Â¥0</span>)</div>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-container-inner" style="max-height: 400px;">
                <canvas id="compoundChart"></canvas>
            </div>
        </div>
    </div>

    <div class="daily-pnl-dashboard" id="dailyPnlPanel">
        <div class="pnl-card">
            <div class="pnl-header">
                <div class="pnl-title">ğŸ’° ä»Šæ—¥ç›ˆäºæ˜ç»† (Daily P&L)</div>
                <div class="pnl-summary">
                    <div class="pnl-summary-item">
                        <span class="pnl-label">ä»Šæ—¥æ€»æ”¶ç›Š</span>
                        <span class="pnl-value" id="totalDailyPnl">Â¥0</span>
                    </div>
                    <div class="pnl-summary-item">
                        <span class="pnl-label">ç›ˆåˆ©åŸºé‡‘</span>
                        <span class="pnl-count" id="profitCount">0</span>
                    </div>
                    <div class="pnl-summary-item">
                        <span class="pnl-label">äºæŸåŸºé‡‘</span>
                        <span class="pnl-count loss" id="lossCount">0</span>
                    </div>
                </div>
            </div>
            <div class="pnl-loading" id="pnlLoading">
                <div class="loading-spinner"></div>
                <div>æ­£åœ¨è·å–ä»Šæ—¥å‡€å€¼æ•°æ®...</div>
            </div>
            <div class="pnl-content" id="pnlContent"></div>
        </div>
    </div>

    <div class="daily-pnl-dashboard" id="estimatePanel">
        <div class="pnl-card">
            <div class="pnl-header">
                <div class="pnl-title">ğŸ“ˆ å®æ—¶é¢„ä¼° (Real-time Estimate)</div>
                <div class="pnl-summary">
                    <div class="pnl-summary-item">
                        <span class="pnl-label">é¢„ä¼°æ€»æ”¶ç›Š</span>
                        <span class="pnl-value" id="totalEstimatePnl">0</span>
                    </div>
                    <div class="pnl-summary-item">
                        <span class="pnl-label">ç›ˆåˆ©åŸºé‡‘</span>
                        <span class="pnl-count" id="estimateProfitCount">0</span>
                    </div>
                    <div class="pnl-summary-item">
                        <span class="pnl-label">äºæŸåŸºé‡‘</span>
                        <span class="pnl-count loss" id="estimateLossCount">0</span>
                    </div>
                </div>
            </div>
            <div class="pnl-loading" id="estimateLoading">
                <div class="loading-spinner"></div>
                <div>æ­£åœ¨è·å–å®æ—¶ä¼°ç®—æ•°æ®...</div>
            </div>
            <div class="pnl-content" id="estimateContent"></div>
        </div>
    </div>

    <div id="sectors-container"></div>

    <button class="btn-add-sector" onclick="createNewSector()">+ æ·»åŠ æ–°æ¿å— (Add Sector)</button>

    <div class="strategy-footer">
        <div class="info-card">
            <div class="info-title">ğŸš€ æ™ºèƒ½åŠ ä»“ç­–ç•¥</div>
            <ul class="strategy-list">
                <li><span class="dot green"></span> <strong>å¸¸è§„å›è°ƒ (-10% ~ -15%)</strong><br>ç»´æŒåŸè®¡åˆ’ï¼Œä¸åŠ¨å¦‚å±±ã€‚</li>
                <li><span class="dot yellow"></span> <strong>æŠ€æœ¯ç†Šå¸‚ (-20% ~ -25%)</strong><br>å¯åŠ¨ <span class="highlight-text">1.5å€ - 2å€</span> å®šæŠ•ã€‚</li>
                <li><span class="dot red"></span> <strong>å²è¯—å´©ç›˜ (> -30%)</strong><br>åŠ¨ç”¨å¤‡ç”¨é‡‘ï¼Œæ¯è·Œ5% <span class="highlight-text">æ‰‹åŠ¨ä¹°å…¥å¤§é¢</span>ã€‚</li>
            </ul>
        </div>
        <div class="info-card">
            <div class="info-title">ğŸ“œ å®šæŠ•å†›è§„</div>
            <ul class="rules-list">
                <li>1. åªè¦ä¸å¤±ä¸šï¼Œç»ä¸åœæ­¢æ‰£æ¬¾ï¼ˆåº•çº¿ï¼‰ã€‚</li>
                <li>2. å»ºä»“æœŸä¸‹è·Œæ˜¯å¥½äº‹ï¼Œè¦â€œç¬‘ç€åŠ ä»“â€ã€‚</li>
                <li>3. æ¯å¹´ç”Ÿæ—¥æ£€æŸ¥ä¸€æ¬¡åŠ¨æ€å¹³è¡¡ï¼Œè‹¥è‚¡ç¥¨å æ¯”>75%åˆ™æ­¢ç›ˆè½¬å€ºã€‚</li>
                <li>4. <strong>ç¾è‚¡é™è´­</strong>: å¯ç”¨å¤šAPPï¼ˆå—æ–¹/åšæ—¶/æ‹›è¡Œï¼‰åˆ†æµã€‚</li>
            </ul>
        </div>
    </div>

</div>

<script>
    // --- é»˜è®¤æ•°æ®æ¨¡ç‰ˆ ---
    const DEFAULT_DATA = {
        totalGoal: 1000000,
        months: 24,
        sectors: [
            {
                id: 'sec_1', name: 'US ç¾è‚¡ (è¿›æ”»ä¸»åŠ›)', color: '#dc2626', weight: 35, strategy: 'sip',
                funds: [{ name: 'æ‘©æ ¹æ ‡æ™®500(A)', code: '019303', share: 0, cost: 0, nav: 1.0, percent: 60 }]
            },
            {
                id: 'sec_2', name: 'CN Aè‚¡ (æˆé•¿å¤è‹)', color: '#db2777', weight: 20, strategy: 'sip',
                funds: [{ name: 'å…´å…¨åˆæ¶¦', code: '163406', share: 0, cost: 0, nav: 1.0, percent: 70 }]
            },
            {
                id: 'sec_3', name: 'çº¢åˆ©ä½æ³¢', color: '#059669', weight: 15, strategy: 'sip',
                funds: [{ name: 'å—æ–¹çº¢åˆ©ä½æ³¢', code: '008163', share: 0, cost: 0, nav: 1.0, percent: 65 }]
            },
            {
                id: 'sec_4', name: 'é»„é‡‘é¿é™©', color: '#d97706', weight: 15, strategy: 'sip',
                funds: [{ name: 'å·¥é“¶é»„é‡‘ETF', code: '008142', share: 0, cost: 0, nav: 1.0, percent: 100 }]
            },
            {
                id: 'sec_5', name: 'å€ºåŸºåº•ä»“', color: '#1890ff', weight: 15, strategy: 'fill',
                funds: [{ name: 'æ‹›å•†äº§ä¸šå€ºA', code: '217022', share: 0, cost: 0, nav: 1.0, percent: 100 }]
            }
        ]
    };

    let appData = null;
    let myChart = null; // å†å¹³è¡¡å›¾è¡¨
    let compoundChart = null; // å¤åˆ©å›¾è¡¨

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        const saved = localStorage.getItem('smartSIP_data_v7'); // å‡çº§åˆ° v7 key
        if (saved) {
            try {
                appData = JSON.parse(saved);
                if (!appData.sectors) throw new Error("Format error");
            } catch (e) {
                console.error(e);
                appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
            }
        } else {
            appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
        
        initChart(); 
        renderApp();
        loadIndexData(); // åŠ è½½æŒ‡æ•°æ•°æ®
    };

    // --- åŠ è½½æŒ‡æ•°æ•°æ® ---
    function loadIndexData() {
        const indices = [
            { id: 'index-ndx', code: '100.NDX', name: 'çº³æ–¯è¾¾å…‹100' },
            { id: 'index-spx', code: '100.SPX', name: 'æ ‡æ™®500' },
            { id: 'index-csi300', code: '1.000300', name: 'æ²ªæ·±300' },
            { id: 'index-redlow', code: '1.515100', name: 'ä¸­è¯çº¢åˆ©ä½æ³¢' },
            { id: 'index-gold', code: '1.518660', name: 'é»„é‡‘' }
        ];

        indices.forEach((index, i) => {
            setTimeout(() => {
                fetchIndexData(index.id, index.code, index.name);
            }, i * 300); // ä¸²è¡Œè¯·æ±‚ï¼Œé—´éš”300ms
        });
    }

    // è·å–å•ä¸ªæŒ‡æ•°æ•°æ®
    function fetchIndexData(elementId, code, name) {
        // ä½¿ç”¨Kçº¿æ¥å£è·å–æœ€æ–°æ•°æ®
        const script = document.createElement('script');
        const callbackName = 'indexCallback_' + elementId.replace(/-/g, '_') + '_' + Date.now();
        
        const timeout = setTimeout(() => {
            cleanup();
            console.error(`è·å–${name}æ•°æ®è¶…æ—¶`);
            updateIndexDisplay(elementId, '--', 0, true);
        }, 10000);

        function cleanup() {
            delete window[callbackName];
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
        }

        window[callbackName] = function(result) {
            clearTimeout(timeout);
            cleanup();
            
            try {
                if (result.rc === 0 && result.data && result.data.klines && result.data.klines.length > 0) {
                    const klines = result.data.klines;
                    
                    // è·å–æœ€æ–°ä¸€å¤©çš„æ•°æ®
                    const latestKline = klines[klines.length - 1];
                    const parts = latestKline.split(',');
                    
                    if (parts.length >= 3) {
                        const latest = parseFloat(parts[2]); // æœ€æ–°æ”¶ç›˜ä»·
                        
                        // è·å–æ˜¨æ—¥æ”¶ç›˜ä»·
                        let yesterday = parseFloat(parts[1]); // ä»Šæ—¥å¼€ç›˜ä»·ï¼ˆé€šå¸¸ç­‰äºæ˜¨æ—¥æ”¶ç›˜ï¼‰
                        
                        // å¦‚æœæœ‰å‰ä¸€å¤©çš„æ•°æ®ï¼Œä½¿ç”¨å‰ä¸€å¤©çš„æ”¶ç›˜ä»·æ›´å‡†ç¡®
                        if (klines.length >= 2) {
                            const prevKline = klines[klines.length - 2];
                            const prevParts = prevKline.split(',');
                            if (prevParts.length >= 3) {
                                yesterday = parseFloat(prevParts[2]);
                            }
                        }
                        
                        const change = latest - yesterday;
                        const changePercent = yesterday > 0 ? (change / yesterday * 100) : 0;

                        updateIndexDisplay(elementId, latest, changePercent);
                    } else {
                        updateIndexDisplay(elementId, '--', 0, true);
                    }
                } else {
                    updateIndexDisplay(elementId, '--', 0, true);
                }
            } catch (e) {
                console.error(`è§£æ${name}æ•°æ®å¤±è´¥:`, e);
                updateIndexDisplay(elementId, '--', 0, true);
            }
        };

        script.onerror = () => {
            clearTimeout(timeout);
            cleanup();
            console.error(`åŠ è½½${name}æ•°æ®å¤±è´¥`);
            updateIndexDisplay(elementId, '--', 0, true);
        };

        // ä½¿ç”¨Kçº¿æ¥å£ï¼Œè·å–æœ€è¿‘2å¤©æ•°æ®
        script.src = `http://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${code}&fields1=f1,f2,f3&fields2=f51,f52,f53&klt=101&fqt=0&end=20500101&lmt=2&cb=${callbackName}`;
        document.head.appendChild(script);
    }

    // æ›´æ–°æŒ‡æ•°æ˜¾ç¤º
    function updateIndexDisplay(elementId, value, changePercent, isError = false) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const valueEl = element.querySelector('.index-value');
        const changeEl = element.querySelector('.index-change');

        if (isError) {
            valueEl.textContent = '--';
            changeEl.textContent = 'æ•°æ®è·å–å¤±è´¥';
            changeEl.className = 'index-change zero';
            return;
        }

        // æ›´æ–°æ•°å€¼
        if (typeof value === 'number') {
            valueEl.textContent = value.toFixed(2);
        } else {
            valueEl.textContent = value;
        }

        // æ›´æ–°æ¶¨è·Œå¹…
        if (changePercent > 0) {
            changeEl.textContent = `+${changePercent.toFixed(2)}%`;
            changeEl.className = 'index-change positive';
        } else if (changePercent < 0) {
            changeEl.textContent = `${changePercent.toFixed(2)}%`;
            changeEl.className = 'index-change negative';
        } else {
            changeEl.textContent = '0.00%';
            changeEl.className = 'index-change zero';
        }
    }

    // --- åŠŸèƒ½å¼€å…³ ---
    function toggleRebalance() {
        const panel = document.getElementById('rebalancePanel');
        const btn = document.getElementById('btnToggleRb');
        const isHidden = panel.style.display !== 'grid';
        
        panel.style.display = isHidden ? 'grid' : 'none';
        btn.innerText = isHidden ? 'ğŸ«£ éšè—å†å¹³è¡¡' : 'ğŸ“Š æ˜¾ç¤ºå†å¹³è¡¡';
        btn.classList.toggle('btn-toggle-active');
        if(isHidden && myChart) myChart.resize(); 
    }

    function toggleCompound() {
        const panel = document.getElementById('compoundPanel');
        const btn = document.getElementById('btnToggleCp');
        const isHidden = panel.style.display !== 'grid';
        
        panel.style.display = isHidden ? 'grid' : 'none';
        btn.innerText = isHidden ? 'ğŸ«£ éšè—æ¨æ¼”' : 'ğŸ§® å¤åˆ©æ¨æ¼”';
        btn.classList.toggle('btn-toggle-active');
        
        if(isHidden) {
            // é¦–æ¬¡å±•å¼€æ—¶ï¼Œè‡ªåŠ¨å¡«å…¥å½“å‰æ€»æŠ•å…¥ç›®æ ‡ä½œä¸ºæœ¬é‡‘
            if(document.getElementById('cpPrincipal').value == "1000000") {
                document.getElementById('cpPrincipal').value = document.getElementById('totalGoal').value;
            }
            calcCompound(); // è®¡ç®—å¹¶ç»˜å›¾
        }
    }

    function toggleDailyPnL() {
        const panel = document.getElementById('dailyPnlPanel');
        const btn = document.getElementById('btnTogglePnl');
        const isHidden = panel.style.display !== 'block';
        
        panel.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? 'ğŸ«£ éšè—ç›ˆäº' : 'ğŸ’° ä»Šæ—¥ç›ˆäº';
        btn.classList.toggle('btn-toggle-active');
        
        if(isHidden) {
            // é¦–æ¬¡å±•å¼€æ—¶ï¼Œè‡ªåŠ¨è·å–ä»Šæ—¥ç›ˆäº
            loadDailyPnL();
        }
    }

    function toggleEstimate() {
        const panel = document.getElementById('estimatePanel');
        const btn = document.getElementById('btnToggleEst');
        const isHidden = panel.style.display !== 'block';
        
        panel.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? 'ğŸ«£ éšè—é¢„ä¼°' : 'ğŸ“ˆ å®æ—¶é¢„ä¼°';
        btn.classList.toggle('btn-toggle-active');
        
        if(isHidden) {
            // é¦–æ¬¡å±•å¼€æ—¶ï¼Œè‡ªåŠ¨è·å–å®æ—¶é¢„ä¼°
            loadEstimate();
        }
    }

    // åŠ è½½ä»Šæ—¥ç›ˆäºæ•°æ®
    function loadDailyPnL() {
        const loadingEl = document.getElementById('pnlLoading');
        const contentEl = document.getElementById('pnlContent');
        
        loadingEl.style.display = 'block';
        contentEl.innerHTML = '';
        
        const fundList = [];
        
        // æ”¶é›†æ‰€æœ‰åŸºé‡‘
        appData.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '' && fund.share > 0) {
                    fundList.push({
                        sectorId: sector.id,
                        sectorName: sector.name,
                        sectorColor: sector.color,
                        code: fund.code,
                        name: fund.name,
                        share: fund.share,
                        costNav: fund.cost
                    });
                }
            });
        });
        
        if (fundList.length === 0) {
            loadingEl.style.display = 'none';
            contentEl.innerHTML = '<div style="padding:60px; text-align:center; color:#999;">æš‚æ— æŒä»“åŸºé‡‘</div>';
            return;
        }
        
        // ä¸²è¡Œè·å–æ¯åªåŸºé‡‘çš„ä»Šæ—¥æ•°æ®
        let currentIndex = 0;
        const results = [];
        
        function fetchNext() {
            if (currentIndex >= fundList.length) {
                // å…¨éƒ¨å®Œæˆï¼Œæ¸²æŸ“ç»“æœ
                loadingEl.style.display = 'none';
                renderDailyPnL(results);
                return;
            }
            
            const fund = fundList[currentIndex];
            currentIndex++;
            
            fetchDailyNavData(fund.code)
                .then(data => {
                    if (data.success) {
                        // è®¡ç®—ä»Šæ—¥æ”¶ç›Š
                        const todayNav = data.nav;
                        const yesterdayNav = data.yesterdayNav || todayNav;
                        const growthRate = yesterdayNav > 0 ? ((todayNav - yesterdayNav) / yesterdayNav * 100) : 0;
                        const dailyProfit = fund.share * (todayNav - yesterdayNav);
                        
                        results.push({
                            ...fund,
                            todayNav: todayNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            dailyProfit: dailyProfit,
                            navDate: data.date
                        });
                    }
                })
                .catch(err => {
                    console.error(`è·å– ${fund.code} å¤±è´¥:`, err);
                })
                .finally(() => {
                    setTimeout(fetchNext, 300);
                });
        }
        
        fetchNext();
    }

    // è·å–åŸºé‡‘ä»Šæ—¥å’Œæ˜¨æ—¥å‡€å€¼
    function fetchDailyNavData(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            function cleanup() {
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            script.onload = function() {
                setTimeout(() => {
                    try {
                        if (window.apidata && window.apidata.content) {
                            const html = window.apidata.content;
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const rows = doc.querySelectorAll('tbody tr');
                            
                            if (rows.length >= 1) {
                                // ä»Šæ—¥å‡€å€¼
                                const todayCells = rows[0].querySelectorAll('td');
                                const todayNav = parseFloat(todayCells[1].textContent.trim()) || 0;
                                const todayDate = todayCells[0].textContent.trim();
                                
                                // æ˜¨æ—¥å‡€å€¼
                                let yesterdayNav = todayNav;
                                if (rows.length >= 2) {
                                    const yesterdayCells = rows[1].querySelectorAll('td');
                                    yesterdayNav = parseFloat(yesterdayCells[1].textContent.trim()) || todayNav;
                                }
                                
                                clearTimeout(timeout);
                                cleanup();
                                resolve({
                                    success: true,
                                    code: code,
                                    nav: todayNav,
                                    yesterdayNav: yesterdayNav,
                                    date: todayDate
                                });
                                return;
                            }
                        }
                        clearTimeout(timeout);
                        cleanup();
                        reject(new Error('No data'));
                    } catch (e) {
                        clearTimeout(timeout);
                        cleanup();
                        reject(e);
                    }
                }, 200);
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `http://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${code}&page=1&per=2&_=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // æ¸²æŸ“ä»Šæ—¥ç›ˆäº
    function renderDailyPnL(results) {
        const contentEl = document.getElementById('pnlContent');
        
        // æŒ‰æ¿å—åˆ†ç»„
        const sectorMap = {};
        results.forEach(item => {
            if (!sectorMap[item.sectorId]) {
                sectorMap[item.sectorId] = {
                    name: item.sectorName,
                    color: item.sectorColor,
                    funds: []
                };
            }
            sectorMap[item.sectorId].funds.push(item);
        });
        
        // è®¡ç®—æ€»æ”¶ç›Š
        let totalProfit = 0;
        let profitCount = 0;
        let lossCount = 0;
        
        results.forEach(item => {
            totalProfit += item.dailyProfit;
            if (item.dailyProfit > 0) profitCount++;
            else if (item.dailyProfit < 0) lossCount++;
        });
        
        // æ›´æ–°é¡¶éƒ¨æ±‡æ€»
        const totalPnlEl = document.getElementById('totalDailyPnl');
        totalPnlEl.textContent = (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2);
        totalPnlEl.style.color = totalProfit >= 0 ? '#ff4d4f' : '#52c41a';
        document.getElementById('profitCount').textContent = profitCount;
        document.getElementById('lossCount').textContent = lossCount;
        
        // æ¸²æŸ“å„æ¿å—
        let html = '';
        appData.sectors.forEach(sector => {
            const sectorData = sectorMap[sector.id];
            if (!sectorData || sectorData.funds.length === 0) return;
            
            // è®¡ç®—æ¿å—æ€»æ”¶ç›Š
            const sectorProfit = sectorData.funds.reduce((sum, f) => sum + f.dailyProfit, 0);
            
            html += `
                <div class="pnl-sector" style="border-top-color: ${sectorData.color}">
                    <div class="pnl-sector-header">
                        <div class="pnl-sector-name">
                            <span style="color:${sectorData.color}; font-size:20px;">â—</span>
                            ${sectorData.name}
                        </div>
                        <div class="pnl-sector-total" style="color: ${sectorProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                            ${sectorProfit >= 0 ? '+' : ''}${sectorProfit.toFixed(2)}
                        </div>
                    </div>
                    <table class="pnl-table">
                        <thead>
                            <tr>
                                <th>åŸºé‡‘ä»£ç </th>
                                <th>åŸºé‡‘åç§°</th>
                                <th>å•ä½å‡€å€¼</th>
                                <th>æ—¥æ¶¨å¹…</th>
                                <th>æŒä»“ä»½é¢</th>
                                <th>ä»Šæ—¥æ”¶ç›Š</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sectorData.funds.forEach(fund => {
                const growthClass = fund.growthRate > 0 ? 'growth-positive' : (fund.growthRate < 0 ? 'growth-negative' : 'growth-zero');
                const profitClass = fund.dailyProfit > 0 ? 'profit-positive' : (fund.dailyProfit < 0 ? 'profit-negative' : 'profit-zero');
                
                html += `
                    <tr>
                        <td><span class="fund-code">${fund.code}</span></td>
                        <td><span class="fund-name">${fund.name}</span></td>
                        <td><span class="nav-value">${fund.todayNav.toFixed(4)}</span></td>
                        <td><span class="growth-rate ${growthClass}">${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%</span></td>
                        <td><span class="share-amount">${fund.share.toLocaleString()}</span></td>
                        <td><span class="daily-profit ${profitClass}">${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        });
        
        contentEl.innerHTML = html;
    }

    // åŠ è½½å®æ—¶é¢„ä¼°æ•°æ®ï¼ˆä½¿ç”¨å¤©å¤©åŸºé‡‘æ¥å£ï¼‰
    function loadEstimate() {
        const loadingEl = document.getElementById('estimateLoading');
        const contentEl = document.getElementById('estimateContent');
        
        loadingEl.style.display = 'block';
        contentEl.innerHTML = '';
        
        const fundList = [];
        
        // æ”¶é›†æ‰€æœ‰åŸºé‡‘
        appData.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '' && fund.share > 0) {
                    fundList.push({
                        sectorId: sector.id,
                        sectorName: sector.name,
                        sectorColor: sector.color,
                        code: fund.code,
                        name: fund.name,
                        share: fund.share,
                        costNav: fund.cost
                    });
                }
            });
        });
        
        if (fundList.length === 0) {
            loadingEl.style.display = 'none';
            contentEl.innerHTML = '<div style="padding:60px; text-align:center; color:#999;">æš‚æ— æŒä»“åŸºé‡‘</div>';
            return;
        }
        
        // ä¸²è¡Œè·å–æ¯åªåŸºé‡‘çš„ä¼°ç®—æ•°æ®
        let currentIndex = 0;
        const results = [];
        
        function fetchNext() {
            if (currentIndex >= fundList.length) {
                // å…¨éƒ¨å®Œæˆï¼Œæ¸²æŸ“ç»“æœ
                loadingEl.style.display = 'none';
                renderEstimate(results);
                return;
            }
            
            const fund = fundList[currentIndex];
            currentIndex++;
            
            fetchEstimateDataFromTTFund(fund.code)
                .then(data => {
                    if (data.success) {
                        // è®¡ç®—é¢„ä¼°æ”¶ç›Š
                        const estimateNav = data.estimateNav;
                        const yesterdayNav = data.yesterdayNav;
                        const growthRate = parseFloat(data.growthRate) || 0;
                        const dailyProfit = fund.share * (estimateNav - yesterdayNav);
                        
                        results.push({
                            ...fund,
                            todayNav: estimateNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            dailyProfit: dailyProfit,
                            estimateTime: data.estimateTime
                        });
                    }
                })
                .catch(err => {
                    console.error(`è·å– ${fund.code} ä¼°ç®—æ•°æ®å¤±è´¥:`, err);
                })
                .finally(() => {
                    setTimeout(fetchNext, 300);
                });
        }
        
        fetchNext();
    }

    // è·å–å¤©å¤©åŸºé‡‘ä¼°ç®—æ•°æ®ï¼ˆç‹¬ç«‹çš„JSONPå¤„ç†ï¼‰
    function fetchEstimateDataFromTTFund(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const callbackName = 'ttfund_' + code + '_' + Date.now();
            
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            // åˆ›å»ºä¸´æ—¶å›è°ƒå‡½æ•°
            window[callbackName] = function(data) {
                clearTimeout(timeout);
                cleanup();
                
                try {
                    if (data && data.fundcode) {
                        const estimateNav = parseFloat(data.gsz) || 0;
                        const yesterdayNav = parseFloat(data.dwjz) || 0;
                        const growthRate = data.gszzl || '0';
                        const estimateTime = data.gztime || '';
                        
                        resolve({
                            success: true,
                            code: code,
                            estimateNav: estimateNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            estimateTime: estimateTime
                        });
                    } else {
                        reject(new Error('Invalid data'));
                    }
                } catch (e) {
                    reject(e);
                }
            };

            function cleanup() {
                delete window[callbackName];
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            // åŠ«æŒjsonpgzå›è°ƒ
            const originalJsonpgz = window.jsonpgz;
            window.jsonpgz = function(data) {
                window[callbackName](data);
                // æ¢å¤åŸå›è°ƒ
                if (originalJsonpgz) {
                    window.jsonpgz = originalJsonpgz;
                }
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // æ¸²æŸ“å®æ—¶é¢„ä¼°
    function renderEstimate(results) {
        const contentEl = document.getElementById('estimateContent');
        
        // æŒ‰æ¿å—åˆ†ç»„
        const sectorMap = {};
        results.forEach(item => {
            if (!sectorMap[item.sectorId]) {
                sectorMap[item.sectorId] = {
                    name: item.sectorName,
                    color: item.sectorColor,
                    funds: []
                };
            }
            sectorMap[item.sectorId].funds.push(item);
        });
        
        // è®¡ç®—æ€»æ”¶ç›Š
        let totalProfit = 0;
        let profitCount = 0;
        let lossCount = 0;
        
        results.forEach(item => {
            totalProfit += item.dailyProfit;
            if (item.dailyProfit > 0) profitCount++;
            else if (item.dailyProfit < 0) lossCount++;
        });
        
        // æ›´æ–°é¡¶éƒ¨æ±‡æ€»
        const totalPnlEl = document.getElementById('totalEstimatePnl');
        totalPnlEl.textContent = (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2);
        totalPnlEl.style.color = totalProfit >= 0 ? '#ff4d4f' : '#52c41a';
        document.getElementById('estimateProfitCount').textContent = profitCount;
        document.getElementById('estimateLossCount').textContent = lossCount;
        
        // æ¸²æŸ“å„æ¿å—
        let html = '';
        appData.sectors.forEach(sector => {
            const sectorData = sectorMap[sector.id];
            if (!sectorData || sectorData.funds.length === 0) return;
            
            // è®¡ç®—æ¿å—æ€»æ”¶ç›Š
            const sectorProfit = sectorData.funds.reduce((sum, f) => sum + f.dailyProfit, 0);
            
            html += `
                <div class="pnl-sector" style="border-top-color: ${sectorData.color}">
                    <div class="pnl-sector-header">
                        <div class="pnl-sector-name">
                            <span style="color:${sectorData.color}; font-size:20px;">â—</span>
                            ${sectorData.name}
                        </div>
                        <div class="pnl-sector-total" style="color: ${sectorProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                            ${sectorProfit >= 0 ? '+' : ''}${sectorProfit.toFixed(2)}
                        </div>
                    </div>
                    <table class="pnl-table">
                        <thead>
                            <tr>
                                <th>åŸºé‡‘ä»£ç </th>
                                <th>åŸºé‡‘åç§°</th>
                                <th>ä¼°ç®—å‡€å€¼</th>
                                <th>ä¼°ç®—æ¶¨å¹…</th>
                                <th>æŒä»“ä»½é¢</th>
                                <th>é¢„ä¼°æ”¶ç›Š</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sectorData.funds.forEach(fund => {
                const growthClass = fund.growthRate > 0 ? 'growth-positive' : (fund.growthRate < 0 ? 'growth-negative' : 'growth-zero');
                const profitClass = fund.dailyProfit > 0 ? 'profit-positive' : (fund.dailyProfit < 0 ? 'profit-negative' : 'profit-zero');
                
                html += `
                    <tr>
                        <td><span class="fund-code">${fund.code}</span></td>
                        <td><span class="fund-name">${fund.name}</span></td>
                        <td><span class="nav-value">${fund.todayNav.toFixed(4)}</span></td>
                        <td><span class="growth-rate ${growthClass}">${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%</span></td>
                        <td><span class="share-amount">${fund.share.toLocaleString()}</span></td>
                        <td><span class="daily-profit ${profitClass}">${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        });
        
        contentEl.innerHTML = html;
    }

    // --- æ ¸å¿ƒè®¡ç®—ï¼šå¤åˆ©è®¡ç®—å™¨ ---
    function calcCompound() {
        const principal = parseFloat(document.getElementById('cpPrincipal').value) || 0;
        const rate = parseFloat(document.getElementById('cpRate').value) / 100 || 0;
        const years = parseFloat(document.getElementById('cpYears').value) || 1;

        // 1. ä¸€æ¬¡æ€§æŠ•å…¥ (Lump Sum)
        // FV = P * (1+r)^n
        const finalLumpSum = principal * Math.pow((1 + rate), years);
        
        // 2. å®šæŠ• (DCA)
        // ç›®æ ‡æ˜¯åœ¨ Years å¹´å†…ï¼Œç´¯è®¡æŠ•å…¥æœ¬é‡‘è¾¾åˆ° principal
        // æ¯æœˆéœ€æŠ•å…¥ = principal / (years * 12)
        const monthlyContrib = principal / (years * 12);
        const monthlyRate = rate / 12;
        let dcaBalance = 0;
        
        // ç”Ÿæˆå›¾è¡¨æ•°æ®
        const labels = [];
        const dataLump = [];
        const dataDCA = [];
        
        let currentLump = principal;
        
        // åˆå§‹ç‚¹ (ç¬¬0å¹´)
        labels.push('Start');
        dataLump.push(principal);
        dataDCA.push(0);

        // æŒ‰å¹´è¿­ä»£è®¡ç®—
        for (let y = 1; y <= years; y++) {
            // Lump Sum å¢é•¿
            currentLump = currentLump * (1 + rate);
            dataLump.push(currentLump);

            // DCA å¢é•¿ (æŒ‰æœˆå¤åˆ©ç´¯åŠ  12æ¬¡)
            for(let m=0; m<12; m++) {
                dcaBalance = (dcaBalance + monthlyContrib) * (1 + monthlyRate);
            }
            dataDCA.push(dcaBalance);
            labels.push(`Year ${y}`);
        }

        // æ›´æ–°UI
        document.getElementById('resLumpSum').innerText = "Â¥" + Math.round(finalLumpSum).toLocaleString();
        document.getElementById('resDCA').innerText = "Â¥" + Math.round(dcaBalance).toLocaleString();
        document.getElementById('cpMonthlyInput').innerText = "Â¥" + Math.round(monthlyContrib).toLocaleString();

        // ç»˜åˆ¶å›¾è¡¨
        renderCompoundChart(labels, dataLump, dataDCA);
    }

    function renderCompoundChart(labels, dataA, dataB) {
        const ctx = document.getElementById('compoundChart').getContext('2d');
        
        if (compoundChart) {
            compoundChart.destroy(); // é”€æ¯æ—§å›¾è¡¨
        }

        compoundChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ä¸€æ¬¡æ€§æŠ•å…¥ (æ¿€è¿›)',
                        data: dataA,
                        borderColor: '#faad14', // æ©™è‰²
                        backgroundColor: 'rgba(250, 173, 20, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'å®šæŠ•ç§¯ç´¯ (ç¨³å¥)',
                        data: dataB,
                        borderColor: '#1890ff', // è“è‰²
                        backgroundColor: 'rgba(24, 144, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // --- å›¾è¡¨åˆå§‹åŒ– (å†å¹³è¡¡) ---
    function initChart() {
        const ctx = document.getElementById('assetChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%', 
                plugins: {
                    legend: { 
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true, 
                            padding: 15,
                            font: { size: 11 }
                        }
                    } 
                }
            }
        });
    }

    // --- æ¸²æŸ“é€»è¾‘ (å®šæŠ•éƒ¨åˆ†) ---
    function renderApp() {
        document.getElementById('totalGoal').value = appData.totalGoal;
        document.getElementById('months').value = appData.months;

        const container = document.getElementById('sectors-container');
        container.innerHTML = ''; 

        appData.sectors.forEach(sector => {
            const sectorHTML = buildSectorHTML(sector);
            container.insertAdjacentHTML('beforeend', sectorHTML);
            
            const tbody = document.getElementById(`tbody-${sector.id}`);
            sector.funds.forEach(fund => {
                tbody.insertAdjacentHTML('beforeend', buildFundRowHTML(sector.id, fund));
            });
        });

        reCalcView(); 
    }

    function buildSectorHTML(sector) {
        return `
        <div class="sector-card" id="${sector.id}" style="border-top-color: ${sector.color}">
            <div class="card-header">
                <div class="header-left">
                    <div class="tool-bar">
                        <input type="color" class="color-picker" value="${sector.color}" onchange="updateSectorColor('${sector.id}', this.value)" title="ä¿®æ”¹é¢œè‰²">
                    </div>
                    <input type="text" class="sector-name-input" value="${sector.name}" onchange="updateSectorName('${sector.id}', this.value)">
                    <select class="strategy-tag" onchange="updateSectorStrategy('${sector.id}', this.value)" title="å®šæŠ•ç­–ç•¥">
                        <option value="sip" ${sector.strategy === 'sip' ? 'selected' : ''}>æ¯æ—¥å®šæŠ•</option>
                        <option value="fill" ${sector.strategy === 'fill' ? 'selected' : ''}>ä¸€æ¬¡æ€§è¡¥ä»“</option>
                    </select>
                </div>
                <div class="header-right">
                    <span class="ratio-label">ç›®æ ‡å æ¯”:</span>
                    <input type="number" class="ratio-input sec-weight" value="${sector.weight}" onchange="calcAll()"> %
                    <span class="progress-mini curr-ratio-text">(å®Œæˆåº¦ 0%)</span>
                    <button class="btn-icon" onclick="deleteSector('${sector.id}')" title="åˆ é™¤æ¿å—">Ã—</button>
                </div>
            </div>
            <div class="table-wrap">
                <table class="fund-table">
                    <thead>
                        <tr>
                            <th width="20%">åŸºé‡‘åç§°</th><th width="12%">ä»£ç </th><th width="12%">ä»½é¢</th><th width="10%">æˆæœ¬</th><th width="10%">å‡€å€¼</th><th width="8%">æ¿å—å†…å æ¯”%</th><th width="12%">å¸‚å€¼/ç›ˆäº</th><th width="15%" style="text-align:right">ä»Šæ—¥å»ºè®®å®šæŠ•</th><th width="3%"></th>
                        </tr>
                    </thead>
                    <tbody class="fund-list" id="tbody-${sector.id}"></tbody>
                </table>
            </div>
            <button class="btn-add-fund" onclick="addFundToSector('${sector.id}')">+ æ·»åŠ åŸºé‡‘</button>
        </div>
        `;
    }

    function buildFundRowHTML(sectorId, fund) {
        return `
            <tr>
                <td><input type="text" class="tb-input f-name" value="${fund.name}" onchange="calcAll()"></td>
                <td><input type="text" class="tb-input f-code" value="${fund.code}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-share" value="${fund.share}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-cost" value="${fund.cost}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-nav" value="${fund.nav}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input tb-sm f-percent" value="${fund.percent}" onchange="calcAll()"></td>
                <td>
                    <div class="val-display">0</div>
                    <div class="pf-sub">--</div>
                </td>
                <td style="text-align:right"><span class="result-pill">Â¥0</span></td>
                <td style="text-align:center"><button class="btn-icon" onclick="delRow(this)">Ã—</button></td>
            </tr>
        `;
    }

    // --- äº¤äº’ä¸è®¡ç®— ---

    function createNewSector() {
        const newId = 'sec_' + Date.now();
        const newSector = {
            id: newId, name: 'æ–°æ¿å—', color: '#999999', weight: 0, strategy: 'sip',
            funds: [{ name: 'æ–°åŸºé‡‘', code: '', share: 0, cost: 0, nav: 1.0, percent: 100 }]
        };
        appData.sectors.push(newSector);
        
        const container = document.getElementById('sectors-container');
        container.insertAdjacentHTML('beforeend', buildSectorHTML(newSector));
        const tbody = document.getElementById(`tbody-${newId}`);
        tbody.insertAdjacentHTML('beforeend', buildFundRowHTML(newId, newSector.funds[0]));
        
        saveToLocal();
    }

    function deleteSector(id) {
        if(!confirm('ç¡®å®šåˆ é™¤è¯¥æ¿å—å—ï¼Ÿ')) return;
        appData.sectors = appData.sectors.filter(s => s.id !== id);
        document.getElementById(id).remove();
        calcAll();
    }

    function addFundToSector(sectorId) {
        const emptyFund = { name: '', code: '', share: 0, cost: 0, nav: 1.0, percent: 0 };
        document.getElementById(`tbody-${sectorId}`).insertAdjacentHTML('beforeend', buildFundRowHTML(sectorId, emptyFund));
        calcAll();
    }

    function delRow(btn) {
        btn.closest('tr').remove();
        calcAll();
    }

    function updateSectorColor(id, color) {
        const sector = appData.sectors.find(s => s.id === id);
        if(sector) sector.color = color;
        document.getElementById(id).style.borderTopColor = color;
        calcAll(); // æ›´æ–°å›¾è¡¨é¢œè‰²
    }
    
    function updateSectorName(id, val) {
        const sector = appData.sectors.find(s => s.id === id);
        if(sector) sector.name = val;
        calcAll(); // æ›´æ–°è¡¨æ ¼åç§°
    }
    
    function updateSectorStrategy(id, val) {
        const sector = appData.sectors.find(s => s.id === id);
        if(sector) sector.strategy = val;
        calcAll();
    }

    function calcAll() {
        // 1. åŒæ­¥é¡¶éƒ¨
        appData.totalGoal = parseFloat(document.getElementById('totalGoal').value) || 0;
        appData.months = parseFloat(document.getElementById('months').value) || 24;
        const days = appData.months * 21.5;

        let currentTotalAsset = 0;
        let totalProfit = 0;
        
        const chartLabels = [];
        const chartData = [];
        const chartColors = [];
        const rebalanceData = [];

        // 2. éå†æ¿å—
        appData.sectors.forEach(sector => {
            const card = document.getElementById(sector.id);
            if (!card) return;

            sector.weight = parseFloat(card.querySelector('.sec-weight').value) || 0;
            
            let sectorCurrentVal = 0;
            const newFundsList = [];

            const rows = card.querySelectorAll('.fund-list tr');
            rows.forEach(row => {
                const name = row.querySelector('.f-name').value;
                const code = row.querySelector('.f-code').value;
                const share = parseFloat(row.querySelector('.f-share').value) || 0;
                const cost = parseFloat(row.querySelector('.f-cost').value) || 0;
                const nav = parseFloat(row.querySelector('.f-nav').value) || 0;
                const percent = parseFloat(row.querySelector('.f-percent').value) || 0;

                newFundsList.push({ name, code, share, cost, nav, percent });

                const marketVal = share * nav;
                const profit = (nav - cost) * share;

                currentTotalAsset += marketVal;
                totalProfit += profit;
                sectorCurrentVal += marketVal;

                // æ›´æ–°è¡ŒUI
                row.querySelector('.val-display').innerText = Math.round(marketVal).toLocaleString();
                const pfEl = row.querySelector('.pf-sub');
                pfEl.innerText = (profit>=0?'+':'') + Math.round(profit).toLocaleString();
                pfEl.className = 'pf-sub ' + (profit>=0 ? 'pf-pos' : 'pf-neg');
            });

            sector.funds = newFundsList;
            sector._tempCurrentVal = sectorCurrentVal;
            
            // æ”¶é›†å›¾è¡¨ä¸å†å¹³è¡¡æ•°æ®
            chartLabels.push(sector.name);
            chartData.push(sectorCurrentVal);
            chartColors.push(sector.color);
            rebalanceData.push({
                name: sector.name,
                color: sector.color,
                currentVal: sectorCurrentVal,
                targetRate: sector.weight
            });
        });

        // 3. æ›´æ–°é¡¶éƒ¨çœ‹æ¿
        const remainToInvest = appData.totalGoal - currentTotalAsset;
        document.getElementById('currTotalAsset').innerText = Math.round(currentTotalAsset).toLocaleString();
        document.getElementById('remainToInvest').innerText = Math.round(remainToInvest).toLocaleString();
        
        const pfDisplay = document.getElementById('totalProfitDisplay');
        pfDisplay.innerHTML = `<span style="font-size:16px; color:${totalProfit>=0?'#ff4d4f':'#52c41a'}">æµ®ç›ˆ ${(totalProfit>=0?'+':'')}${Math.round(totalProfit).toLocaleString()}</span>`;
        document.getElementById('overBudgetWarning').style.display = currentTotalAsset > appData.totalGoal ? 'block' : 'none';

        // 4. æ›´æ–°å›¾è¡¨ä¸å†å¹³è¡¡è¡¨
        updateDashboard(chartLabels, chartData, chartColors, rebalanceData, currentTotalAsset);

        // 5. è®¡ç®—å®šæŠ•ç¼ºå£
        appData.sectors.forEach(sector => {
            const card = document.getElementById(sector.id);
            if(!card) return;

            const targetSectorVal = appData.totalGoal * (sector.weight / 100);
            const ratio = targetSectorVal > 0 ? (sector._tempCurrentVal / targetSectorVal * 100) : 0;
            card.querySelector('.curr-ratio-text').innerText = `(å®Œæˆåº¦ ${ratio.toFixed(1)}%)`;

            const rows = card.querySelectorAll('.fund-list tr');
            rows.forEach((row, idx) => {
                const fund = sector.funds[idx];
                const fundCurrentVal = fund.share * fund.nav;
                const fundTargetVal = appData.totalGoal * (sector.weight/100) * (fund.percent/100);
                const gap = fundTargetVal - fundCurrentVal;

                const pill = row.querySelector('.result-pill');
                if (gap > 0) {
                    let amount = 0;
                    if (sector.strategy === 'fill') amount = gap;
                    else amount = gap / days;
                    
                    pill.className = 'result-pill';
                    pill.innerText = `Â¥${Math.round(amount).toLocaleString()}`;
                } else {
                    pill.className = 'result-pill res-stop';
                    pill.innerText = 'æš‚åœ';
                }
            });
        });

        saveToLocal();
    }

    // --- æ›´æ–°å›¾è¡¨ä¸å†å¹³è¡¡è¡¨ ---
    function updateDashboard(labels, data, colors, rbData, totalAsset) {
        // æ›´æ–°å›¾è¡¨
        if (myChart) {
            myChart.data.labels = labels;
            myChart.data.datasets[0].data = data;
            myChart.data.datasets[0].backgroundColor = colors;
            myChart.update();
        }

        // æ›´æ–°è¡¨æ ¼
        const tbody = document.getElementById('rebalanceBody');
        tbody.innerHTML = '';
        
        rbData.forEach(item => {
            const actualRate = totalAsset > 0 ? (item.currentVal / totalAsset * 100) : 0;
            const diffRate = actualRate - item.targetRate;
            
            const targetVal = totalAsset * (item.targetRate / 100);
            const actionAmount = targetVal - item.currentVal; // æ­£æ•°=éœ€ä¹°å…¥(çº¢è‰²)ï¼Œè´Ÿæ•°=éœ€å–å‡º(ç»¿è‰²)

            let statusHtml = '<span class="tag-status st-ok">è¾¾æ ‡</span>';
            let actionHtml = '-';

            // é˜ˆå€¼ 2%
            if (diffRate > 2) {
                statusHtml = `<span class="tag-status st-over">è¶…é… ${diffRate.toFixed(1)}%</span>`;
                actionHtml = `<span class="rb-action act-sell">å–å‡º Â¥${Math.round(Math.abs(actionAmount)).toLocaleString()}</span>`;
            } else if (diffRate < -2) {
                statusHtml = `<span class="tag-status st-under">ä½é… ${Math.abs(diffRate).toFixed(1)}%</span>`;
                actionHtml = `<span class="rb-action act-buy">ä¹°å…¥ Â¥${Math.round(Math.abs(actionAmount)).toLocaleString()}</span>`;
            }

            const tr = `
                <tr>
                    <td><span style="color:${item.color}; font-weight:bold; margin-right:5px;">â—</span>${item.name}</td>
                    <td style="text-align:center; font-weight:bold;">${actualRate.toFixed(1)}%</td>
                    <td style="text-align:center; color:#999;">${item.targetRate}%</td>
                    <td style="text-align:center;">${statusHtml}</td>
                    <td style="text-align:right;">${actionHtml}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', tr);
        });
    }

    function reCalcView() { calcAll(); }

    function saveToLocal() {
        localStorage.setItem('smartSIP_data_v7', JSON.stringify(appData));
    }

    // --- è”ç½‘åŠŸèƒ½ï¼šåŒæ­¥åŸºé‡‘å®é™…å‡€å€¼ï¼ˆä»…ä¸œæ–¹è´¢å¯Œï¼‰ ---
    function syncAllFundNav() {
        const statusEl = document.getElementById('syncStatus');
        statusEl.innerHTML = '<span class="sync-status sync-loading">ğŸ”„ æ­£åœ¨åŒæ­¥å‡€å€¼æ•°æ®...</span>';
        
        let totalFunds = 0;
        let successCount = 0;
        let errorCount = 0;
        const fundCodes = [];

        // æ”¶é›†æ‰€æœ‰åŸºé‡‘ä»£ç 
        appData.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '') {
                    totalFunds++;
                    fundCodes.push({ code: fund.code, sectorId: sector.id });
                }
            });
        });

        if (totalFunds === 0) {
            statusEl.innerHTML = '<span class="sync-status sync-error">âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åŸºé‡‘ä»£ç </span>';
            return;
        }

        // ä¸²è¡Œè¯·æ±‚ï¼Œé¿å…apidataå†²çª
        let currentIndex = 0;
        
        function fetchNext() {
            if (currentIndex >= fundCodes.length) {
                // å…¨éƒ¨å®Œæˆ
                if (errorCount === 0) {
                    statusEl.innerHTML = `<span class="sync-status sync-success">âœ… æˆåŠŸåŒæ­¥ ${successCount} åªåŸºé‡‘å‡€å€¼</span>`;
                } else {
                    statusEl.innerHTML = `<span class="sync-status sync-error">âš ï¸ åŒæ­¥å®Œæˆï¼šæˆåŠŸ ${successCount} åªï¼Œå¤±è´¥ ${errorCount} åª</span>`;
                }
                setTimeout(() => { statusEl.innerHTML = ''; }, 5000);
                calcAll();
                return;
            }
            
            const item = fundCodes[currentIndex];
            currentIndex++;
            
            fetchActualNavFromEastmoney(item.code)
                .then(result => {
                    if (result.success) {
                        successCount++;
                        updateFundNavInUI(result.code, result.nav, result.time);
                    } else {
                        errorCount++;
                    }
                })
                .catch(() => {
                    errorCount++;
                })
                .finally(() => {
                    // ç»§ç»­ä¸‹ä¸€ä¸ª
                    setTimeout(fetchNext, 300); // å»¶è¿Ÿ300msé¿å…è¯·æ±‚è¿‡å¿«
                });
        }
        
        fetchNext();
    }

    // ä»ä¸œæ–¹è´¢å¯Œè·å–å®é™…å‡€å€¼
    function fetchActualNavFromEastmoney(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const uniqueId = 'apidata_' + code + '_' + Date.now();
            
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            function cleanup() {
                if (window[uniqueId]) {
                    delete window[uniqueId];
                }
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            script.onload = function() {
                // ç»™ä¸€ç‚¹æ—¶é—´è®©è„šæœ¬æ‰§è¡Œ
                setTimeout(() => {
                    try {
                        // ä¸œæ–¹è´¢å¯Œæ¥å£ä¼šè®¾ç½®å…¨å±€å˜é‡ apidata
                        if (window.apidata && window.apidata.content) {
                            const html = window.apidata.content;
                            
                            // ç«‹å³ä¿å­˜åˆ°å”¯ä¸€å˜é‡ï¼Œé¿å…è¢«è¦†ç›–
                            window[uniqueId] = JSON.parse(JSON.stringify(window.apidata));
                            
                            // è§£æHTMLè¡¨æ ¼
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const rows = doc.querySelectorAll('tbody tr');
                            
                            if (rows.length > 0) {
                                const firstRow = rows[0];
                                const cells = firstRow.querySelectorAll('td');
                                
                                if (cells.length >= 2) {
                                    const date = cells[0].textContent.trim();
                                    const nav = parseFloat(cells[1].textContent.trim()) || 0;
                                    
                                    clearTimeout(timeout);
                                    cleanup();
                                    resolve({
                                        success: true,
                                        code: code,
                                        nav: nav,
                                        time: date
                                    });
                                    return;
                                }
                            }
                        }
                        clearTimeout(timeout);
                        cleanup();
                        reject(new Error('No data'));
                    } catch (e) {
                        clearTimeout(timeout);
                        cleanup();
                        reject(e);
                    }
                }, 200);
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `http://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${code}&page=1&per=1&_=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // æ›´æ–°UIä¸­çš„å‡€å€¼
    function updateFundNavInUI(code, nav, time) {
        // æ›´æ–°appData
        appData.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code === code) {
                    fund.nav = nav;
                }
            });
        });

        // æ›´æ–°UIè¾“å…¥æ¡†
        document.querySelectorAll('.f-code').forEach(input => {
            if (input.value === code) {
                const row = input.closest('tr');
                const navInput = row.querySelector('.f-nav');
                navInput.value = nav.toFixed(4);
                navInput.style.color = '#52c41a'; // ç»¿è‰²è¡¨ç¤ºå®é™…å‡€å€¼
                navInput.title = `å®é™…å‡€å€¼ (${time})`;
            }
        });

        saveToLocal();
    }

    function exportData() {
        const str = localStorage.getItem('smartSIP_data_v7');
        if (!str) return alert("æ— æ•°æ®");
        const blob = new Blob([str], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æŠ•èµ„ç­–ç•¥V7_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(input) {
        const f = input.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                if(!json.sectors) throw new Error();
                appData = json;
                saveToLocal();
                renderApp();
                alert("é…ç½®å·²æ¢å¤");
            } catch(e){ alert("æ–‡ä»¶æ ¼å¼é”™è¯¯"); }
        };
        r.readAsText(f);
        input.value = '';
    }
</script>

</body>
</html>