# 智能定投补仓系统 - 项目说明文档

## 📋 项目概述

这是一个完整的基金投资组合管理系统，包含Web界面和Python API接口。系统支持基金净值同步、实时估算、今日盈亏计算、全球指数监控等功能。

**项目版本**: V6.5  
**最后更新**: 2026-02-05

---

## 📁 项目文件结构

```
持仓基金净值系统/
├── 我的智能定投补仓系统6.5.html    # 主Web应用（单文件）
├── fund_api.py                      # Python API完整版
├── fund_api_simple.py               # Python API简化版
├── README_API.md                    # API使用文档
└── 项目说明文档.md                  # 本文档
```

---

## 🎯 核心功能

### 1. Web界面功能（HTML）

#### 1.1 全球市场指数面板
- **位置**: 页面最顶部
- **显示内容**:
  - 纳斯达克100 (100.NDX)
  - 标普500 (100.SPX)
  - 沪深300 (1.000300)
  - 中证红利低波 (1.515100)
  - 黄金ETF (1.518660)
- **数据来源**: 东方财富接口
- **更新方式**: 页面加载时自动获取，串行请求间隔300ms
- **显示格式**: 最新点位（2位小数）+ 涨跌幅（红涨绿跌）

#### 1.2 配置面板
- 计划总投入金额
- 计划定投周期（月）
- 已持仓市值统计
- 剩余需投入金额
- 功能按钮组：
  - 📊 显示再平衡
  - 🧮 复利推演
  - 💰 今日盈亏
  - 📈 实时预估
  - 🔄 同步实时净值
  - ⬇️ 备份配置
  - ⬆️ 恢复配置

#### 1.3 今日盈亏功能
- **数据源**: 东方财富F10DataApi接口（实际净值）
- **计算逻辑**: 
  - 获取今日和昨日净值
  - 计算日涨跌幅 = (今日净值 - 昨日净值) / 昨日净值 × 100%
  - 今日收益 = 持仓份额 × (今日净值 - 昨日净值)
- **显示内容**:
  - 按板块分组展示
  - 每只基金显示：代码、名称、单位净值、日涨幅、持仓份额、今日收益
  - 顶部汇总：今日总收益、盈利基金数、亏损基金数
- **视觉设计**:
  - 板块顶部5px彩色条
  - 独立卡片设计，圆角阴影
  - 板块间15px间距
  - 浅灰色背景(#f0f2f5)区分内容区

#### 1.4 实时预估功能
- **数据源**: 天天基金接口（fundgz.1234567.com.cn）
- **计算逻辑**:
  - 获取估算净值(gsz)和估算涨跌幅(gszzl)
  - 预估收益 = 持仓份额 × (估算净值 - 昨日净值)
- **JSONP处理**:
  - 每个请求创建唯一临时回调: `ttfund_{code}_{timestamp}`
  - 劫持window.jsonpgz，调用临时回调后恢复
  - 串行请求，间隔300ms
- **显示格式**: 与今日盈亏相同

#### 1.5 同步实时净值
- **数据源**: 东方财富F10DataApi接口
- **更新对象**: 所有板块中的基金净值
- **请求方式**: 串行请求，间隔300ms避免冲突
- **显示反馈**: 绿色提示框显示同步状态

#### 1.6 板块管理
- 支持多板块配置
- 每个板块包含：
  - 板块名称（可编辑）
  - 板块颜色（可选择）
  - 目标占比（%）
  - 定投策略（每日定投/一次性补仓）
  - 基金列表

#### 1.7 基金管理
- 每只基金包含：
  - 基金名称
  - 基金代码
  - 持仓份额
  - 成本价
  - 最新净值
  - 板块内占比
  - 市值/盈亏显示
  - 今日建议定投金额

#### 1.8 再平衡分析
- 饼图显示资产分布
- 智能再平衡建议表格
- 显示实际占比vs目标占比
- 给出买入/卖出建议金额

#### 1.9 复利计算器
- 一次性投入vs定投对比
- 可调参数：本金、年化收益率、持有年数
- 折线图展示复利增长曲线

#### 1.10 数据持久化
- 使用localStorage存储配置
- 支持导出JSON配置文件
- 支持导入配置文件恢复

---

### 2. Python API功能

#### 2.1 指数数据接口
```python
get_index_data(index_code, index_name='')
```
- **功能**: 获取指数实时行情
- **支持指数**:
  - 纳斯达克100: `100.NDX`
  - 标普500: `100.SPX`
  - 沪深300: `1.000300`
  - 上证指数: `1.000001`
  - 中证红利低波: `1.515100`
  - 黄金ETF: `1.518660`
- **返回数据**: 最新价、昨收价、涨跌额、涨跌幅、最高价、最低价
- **注意**: 所有价格需除以100

#### 2.2 实际净值接口
```python
get_actual_nav(fund_code)
get_actual_nav_eastmoney(fund_code)  # 完整版
```
- **数据源**: 东方财富F10DataApi
- **返回数据**: 单位净值、累计净值、净值日期、日增长率
- **更新时间**: 交易日晚上18:00-22:00
- **特点**: 获取最新实际净值（基金公司已公布）

#### 2.3 估算净值接口
```python
get_estimate_nav(fund_code)
get_estimate_nav_ttfund(fund_code)  # 完整版
```
- **数据源**: 天天基金JSONP接口
- **返回数据**: 前一日净值、估算净值、估算涨跌幅、估值时间
- **更新时间**: 交易日9:30-15:00实时更新
- **特点**: 提供交易时间内的实时估算

---

## 🔧 技术实现细节

### 1. 接口调用规范

#### 东方财富F10DataApi接口
```javascript
// URL格式
http://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code={基金代码}&page=1&per=2

// 返回格式：HTML表格
// 解析方式：BeautifulSoup / DOMParser
// 数据提取：tbody tr td
```

#### 东方财富指数接口
```javascript
// URL格式
http://push2.eastmoney.com/api/qt/stock/get?secid={指数代码}&fields=f43,f51,f52,f58,f60

// 返回格式：JSON
// 字段说明：
// f43: 最新价（需除以100）
// f51: 最高价（需除以100）
// f52: 最低价（需除以100）
// f58: 指数名称
// f60: 昨收价（需除以100）
```

#### 天天基金估算接口
```javascript
// URL格式
https://fundgz.1234567.com.cn/js/{基金代码}.js

// 返回格式：JSONP
// 回调函数：jsonpgz
// 数据字段：
// fundcode: 基金代码
// name: 基金名称
// jzrq: 净值日期（前一日）
// dwjz: 单位净值（前一日）
// gsz: 估算净值
// gszzl: 估算涨跌幅
// gztime: 估值时间
```

### 2. 关键技术点

#### 2.1 串行请求机制
```javascript
// 避免并发请求导致数据冲突
function fetchNext() {
    if (currentIndex >= fundList.length) {
        // 全部完成
        renderResults();
        return;
    }
    
    const fund = fundList[currentIndex];
    currentIndex++;
    
    fetchData(fund.code)
        .then(data => {
            results.push(data);
        })
        .finally(() => {
            setTimeout(fetchNext, 300); // 间隔300ms
        });
}
```

#### 2.2 JSONP回调处理
```javascript
// 为每个请求创建唯一回调
const callbackName = 'ttfund_' + code + '_' + Date.now();

window[callbackName] = function(data) {
    // 处理数据
    resolve(data);
    // 清理回调
    delete window[callbackName];
};

// 劫持全局回调
const originalJsonpgz = window.jsonpgz;
window.jsonpgz = function(data) {
    window[callbackName](data);
    // 恢复原回调
    if (originalJsonpgz) {
        window.jsonpgz = originalJsonpgz;
    }
};
```

#### 2.3 HTML解析方式
```python
# Python方式
from bs4 import BeautifulSoup
soup = BeautifulSoup(response.text, 'html.parser')
rows = soup.select('tbody tr')
cells = rows[0].find_all('td')

# JavaScript方式
const parser = new DOMParser();
const doc = parser.parseFromString(html, 'text/html');
const rows = doc.querySelectorAll('tbody tr');
const cells = rows[0].querySelectorAll('td');
```

#### 2.4 数据计算公式
```javascript
// 涨跌幅计算
growthRate = (todayNav - yesterdayNav) / yesterdayNav × 100%

// 今日收益计算
dailyProfit = shares × (todayNav - yesterdayNav)

// 总市值计算
marketValue = shares × currentNav

// 盈亏计算
profit = shares × (currentNav - costNav)
profitRate = (currentNav - costNav) / costNav × 100%
```

---

## 🎨 UI设计规范

### 1. 颜色系统
```css
:root {
    --bg-body: #f0f2f5;        /* 页面背景 */
    --bg-card: #ffffff;        /* 卡片背景 */
    --primary: #1890ff;        /* 主色调 */
    --text-main: #333333;      /* 主文字 */
    --text-sub: #666666;       /* 次要文字 */
    --border: #e8e8e8;         /* 边框 */
    
    --pos: #ff4d4f;            /* 涨/买入/超配 - 红色 */
    --neg: #52c41a;            /* 跌/卖出/低配 - 绿色 */
    --warn: #faad14;           /* 警告 - 橙色 */
}
```

### 2. 指数面板设计
```css
/* 渐变紫色背景 */
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

/* 半透明卡片 */
background: rgba(255, 255, 255, 0.15);
backdrop-filter: blur(10px);

/* 响应式布局 */
grid-template-columns: repeat(5, 1fr);  /* 大屏 */
grid-template-columns: repeat(3, 1fr);  /* 中屏 */
grid-template-columns: repeat(2, 1fr);  /* 小屏 */
```

### 3. 盈亏面板设计
```css
/* 板块卡片 */
border-top: 5px solid {板块颜色};
border-radius: 8px;
box-shadow: 0 2px 8px rgba(0,0,0,0.06);
margin-bottom: 15px;

/* 板块间距 */
padding: 25px;
background: #f0f2f5;  /* 与页面背景一致 */

/* 表格列宽固定 */
th:nth-child(1) { width: 10%; }  /* 基金代码 */
th:nth-child(2) { width: 25%; }  /* 基金名称 */
th:nth-child(3) { width: 12%; }  /* 单位净值 */
th:nth-child(4) { width: 12%; }  /* 日涨幅 */
th:nth-child(5) { width: 15%; }  /* 持仓份额 */
th:nth-child(6) { width: 16%; text-align: right; }  /* 今日收益 */
```

### 4. 数值显示规范
```javascript
// 净值：4位小数
nav.toFixed(4)  // 2.1925

// 涨跌幅：2位小数 + 符号
growthRate.toFixed(2) + '%'  // +1.23% 或 -0.56%

// 金额：2位小数，无¥符号
profit.toFixed(2)  // 123.45

// 指数点位：2位小数
index.toFixed(2)  // 22904.58
```

---

## 📊 数据流程图

### 1. 今日盈亏数据流
```
用户点击"今日盈亏" 
  ↓
收集所有持仓基金
  ↓
串行请求东方财富接口（间隔300ms）
  ↓
解析HTML获取今日和昨日净值
  ↓
计算涨跌幅和今日收益
  ↓
按板块分组
  ↓
渲染UI（板块卡片 + 表格）
  ↓
更新顶部汇总数据
```

### 2. 实时预估数据流
```
用户点击"实时预估"
  ↓
收集所有持仓基金
  ↓
串行请求天天基金接口（间隔300ms）
  ↓
处理JSONP回调获取估算数据
  ↓
计算预估收益
  ↓
按板块分组
  ↓
渲染UI（与今日盈亏相同格式）
  ↓
更新顶部汇总数据
```

### 3. 指数数据流
```
页面加载
  ↓
调用loadIndexData()
  ↓
串行请求5个指数（间隔300ms）
  ↓
解析JSON数据
  ↓
价格除以100
  ↓
计算涨跌幅
  ↓
更新UI显示
```

---

## 🔐 数据存储结构

### localStorage数据格式
```javascript
{
    "totalGoal": 1000000,      // 计划总投入
    "months": 24,              // 计划周期
    "sectors": [               // 板块数组
        {
            "id": "sec_1",
            "name": "US 美股",
            "color": "#dc2626",
            "weight": 35,      // 目标占比%
            "strategy": "sip", // sip=定投, fill=补仓
            "funds": [         // 基金数组
                {
                    "name": "摩根标普500",
                    "code": "019303",
                    "share": 1000,     // 持仓份额
                    "cost": 1.5,       // 成本价
                    "nav": 1.6,        // 最新净值
                    "percent": 60      // 板块内占比%
                }
            ]
        }
    ]
}
```

---

## 🚀 使用指南

### 1. Web界面使用

#### 启动方式
直接用浏览器打开 `我的智能定投补仓系统6.5.html` 文件即可。

#### 基本操作
1. **配置投资计划**: 设置总投入金额和定投周期
2. **添加板块**: 点击"添加新板块"按钮
3. **配置板块**: 设置板块名称、颜色、目标占比
4. **添加基金**: 在板块内点击"添加基金"
5. **输入持仓**: 填写基金代码、份额、成本价
6. **同步净值**: 点击"同步实时净值"获取最新数据
7. **查看盈亏**: 点击"今日盈亏"查看当日收益
8. **查看预估**: 点击"实时预估"查看实时估算

#### 数据备份
- 点击"备份配置"导出JSON文件
- 点击"恢复配置"导入JSON文件

### 2. Python API使用

#### 安装依赖
```bash
pip install requests beautifulsoup4
```

#### 简化版使用
```python
from fund_api_simple import get_index_data, get_actual_nav, get_estimate_nav

# 获取指数
data = get_index_data('100.NDX', '纳斯达克100')
print(f"{data['name']}: {data['latest']:.2f} ({data['change_percent']:+.2f}%)")

# 获取实际净值
result = get_actual_nav('163406')
print(f"净值: {result['nav']}, 日期: {result['date']}")

# 获取估算净值
result = get_estimate_nav('163406')
print(f"估算: {result['estimate_nav']}, 涨跌: {result['growth']}%")
```

#### 完整版使用
```python
from fund_api import FundAPI

api = FundAPI()

# 获取指数
api.get_index_data('100.NDX', '纳斯达克100')

# 获取净值
api.get_actual_nav_eastmoney('163406')
api.get_estimate_nav_ttfund('163406')

# 对比数据源
api.compare_sources('163406')
```

---

## ⚠️ 注意事项

### 1. 接口限制
- 请求频率：建议间隔300ms以上
- 避免并发请求，使用串行方式
- 失败重试：建议最多重试3次

### 2. 数据更新时间
- **指数数据**: 交易时间实时更新
- **实际净值**: 交易日晚上18:00-22:00更新
- **估算净值**: 交易日9:30-15:00实时更新
- **节假日**: 返回最近交易日数据

### 3. 浏览器兼容性
- 推荐使用Chrome、Edge、Firefox最新版
- 需要支持ES6、Fetch API、LocalStorage
- 需要允许跨域请求（CORS）

### 4. 数据准确性
- 实际净值：最准确，基金公司官方数据
- 估算净值：仅供参考，存在误差
- 指数数据：实时行情，可能有延迟

---

## 🐛 常见问题

### Q1: 指数数据获取失败？
**A**: 检查指数代码格式是否正确，确保前缀正确（100.xxx或1.xxx）

### Q2: 净值同步一直转圈？
**A**: 可能是网络问题或接口限流，刷新页面重试

### Q3: 今日盈亏显示"数据获取失败"？
**A**: 
- 检查基金代码是否正确
- 确认是否在更新时间内
- 非交易日会显示最近交易日数据

### Q4: 实时预估无法获取？
**A**: 
- 天天基金接口仅在交易时间更新
- 部分基金可能不支持实时估算
- 检查网络连接和CORS设置

### Q5: Python API连接失败？
**A**: 
- 检查网络连接
- 添加请求延迟（time.sleep(0.3)）
- 检查防火墙设置

---

## 📝 更新日志

### V6.5 (2026-02-05)
- ✅ 新增全球市场指数面板（顶部）
- ✅ 支持5个指数实时监控
- ✅ Python API新增指数接口
- ✅ 优化JSONP回调处理机制
- ✅ 修复中证红利低波指数代码

### V6.4
- ✅ 新增实时预估功能
- ✅ 使用天天基金接口获取估算数据
- ✅ 独立JSONP回调处理

### V6.3
- ✅ 新增今日盈亏功能
- ✅ 优化板块视觉设计
- ✅ 表格列宽固定对齐
- ✅ 板块卡片独立化

### V6.2
- ✅ 移除天天基金估算接口
- ✅ 统一使用东方财富实际净值
- ✅ 优化串行请求机制

### V6.1
- ✅ 新增网络功能
- ✅ 集成东方财富接口
- ✅ 实时净值同步

### V6.0
- ✅ 初始版本
- ✅ 基础定投管理功能
- ✅ 再平衡分析
- ✅ 复利计算器

---

## 🔮 未来计划

### 短期计划
- [ ] 添加历史净值曲线图
- [ ] 支持更多指数监控
- [ ] 优化移动端适配
- [ ] 添加数据导出Excel功能

### 长期计划
- [ ] 开发微信小程序版本
- [ ] 部署在线版本
- [ ] 添加用户账号系统
- [ ] 支持多设备同步

---

## 📞 联系方式

如有问题或建议，欢迎反馈！

---

**文档版本**: V1.0  
**最后更新**: 2026-02-05  
**维护者**: AI Assistant
